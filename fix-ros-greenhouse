#!/bin/bash
# Quick fix - Ensure ROS greenhouse is actually running

echo "ðŸ”§ Ensuring ROS Greenhouse System is Running"
echo "=============================================="
echo ""

# Check if greenhouse node exists
if docker exec ros2-jazzy-bridge bash -c "ros2 node list 2>/dev/null | grep -q greenhouse" 2>/dev/null; then
    echo "âœ… Greenhouse ROS nodes already active"
    echo ""
    echo "Nodes:"
    docker exec ros2-jazzy-bridge bash -c "ros2 node list 2>/dev/null | grep greenhouse"
else
    echo "âš ï¸  Greenhouse ROS nodes not found - starting now..."
    echo ""
    
    # Start greenhouse launch
    docker exec -d ros2-jazzy-bridge bash -c "
        cd /app &&
        source /opt/ros/jazzy/setup.bash &&
        source install/setup.bash &&
        export MOCK_MODE=true &&
        ros2 launch demo greenhouse.launch.py > /tmp/greenhouse.log 2>&1 &
        echo \$! > /tmp/greenhouse.pid
    "
    
    echo "Launched greenhouse nodes, waiting for startup..."
    
    # Wait for nodes to appear
    for i in {1..15}; do
        sleep 2
        if docker exec ros2-jazzy-bridge bash -c "ros2 node list 2>/dev/null | grep -q greenhouse" 2>/dev/null; then
            echo ""
            echo "âœ… Greenhouse nodes are now active!"
            echo ""
            echo "Active nodes:"
            docker exec ros2-jazzy-bridge bash -c "ros2 node list 2>/dev/null | grep greenhouse" | sed 's/^/  â€¢ /'
            echo ""
            echo "Active topics:"
            docker exec ros2-jazzy-bridge bash -c "ros2 topic list 2>/dev/null | grep greenhouse" | sed 's/^/  â€¢ /'
            break
        fi
        echo "  Waiting for greenhouse nodes... ($i/15)"
    done
fi

echo ""
echo "Testing TCP connection to ROS..."
python3 << 'PYEOF'
import socket
import json
import sys

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(5)
    s.connect(("localhost", 9999))
    
    # Test ping
    s.send(json.dumps({"action": "ping"}).encode() + b'\n')
    data = b''
    while b'\n' not in data:
        chunk = s.recv(4096)
        if not chunk: break
        data += chunk
    
    response = json.loads(data.decode().strip())
    s.close()
    
    if response.get("status") == "ok":
        print("âœ… TCP server responding")
    else:
        print("âš ï¸  TCP server responded with error")
        
except Exception as e:
    print(f"âŒ TCP connection failed: {e}")
    sys.exit(1)
PYEOF

echo ""
echo "=============================================="
echo "Try: ./openclaw-robot-skill status"
