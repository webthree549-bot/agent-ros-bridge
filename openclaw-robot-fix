#!/bin/bash
# Fix and test TCP server

echo "ðŸ”§ Fixing TCP server..."

# Step 1: Kill any existing server
echo "1. Stopping existing server..."
docker exec ros2-jazzy-bridge pkill -f "openclaw_tcp_server" 2>/dev/null || true
sleep 2

# Step 2: Clear old logs
echo "2. Clearing old logs..."
docker exec ros2-jazzy-bridge rm -f /tmp/tcp_server.log

# Step 3: Start server with proper initialization
echo "3. Starting TCP server..."
docker exec -d ros2-jazzy-bridge bash -c "
    cd /app && 
    source /opt/ros/jazzy/setup.bash && 
    source install/setup.bash 2>/dev/null || true &&
    export MOCK_MODE=true &&
    python3 -u /app/openclaw_ros_bridge/communication/openclaw_tcp_server.py > /tmp/tcp_server.log 2>&1 &
    sleep 2 &&
    echo 'Server PID:' \$(pgrep -f openclaw_tcp_server) > /tmp/server.pid
"

# Wait for startup
sleep 5

# Step 4: Check if running
echo "4. Checking if server is running..."
if docker exec ros2-jazzy-bridge pgrep -f "openclaw_tcp_server" > /dev/null 2>&1; then
    echo "   âœ“ Server process found"
else
    echo "   âŒ Server process not found"
    echo "   Logs:"
    docker exec ros2-jazzy-bridge cat /tmp/tcp_server.log 2>/dev/null | tail -10
    exit 1
fi

# Step 5: Test with simple Python
echo "5. Testing connection..."
python3 << 'PYEOF'
import socket
import json
import time

try:
    # Create socket
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(5)
    
    # Connect
    print("   Connecting...")
    s.connect(("localhost", 9999))
    print("   âœ“ Connected")
    
    # Send simple ping
    print("   Sending ping...")
    ping_cmd = json.dumps({"action": "ping"}) + "\n"
    s.sendall(ping_cmd.encode())
    print("   âœ“ Sent")
    
    # Receive response
    print("   Receiving...")
    response = s.recv(4096).decode()
    print(f"   âœ“ Received: {response.strip()}")
    
    # Parse
    data = json.loads(response.strip())
    if data.get("status") == "ok":
        print("   âœ“ Server responding correctly!")
    else:
        print(f"   âš ï¸  Server error: {data}")
    
    s.close()
    
except Exception as e:
    print(f"   âŒ Error: {e}")
    import traceback
    traceback.print_exc()
PYEOF

echo ""
echo "========================================"
if [ $? -eq 0 ]; then
    echo "âœ… TCP server is working!"
    echo ""
    echo "Try: ./openclaw-robot-skill status"
else
    echo "âŒ TCP server test failed"
    echo ""
    echo "Check logs: docker exec ros2-jazzy-bridge cat /tmp/tcp_server.log"
fi
