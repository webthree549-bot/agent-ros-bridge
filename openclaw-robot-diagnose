#!/bin/bash
# Diagnose TCP connection issues

echo "ðŸ” Diagnosing OpenClaw Robot Connection"
echo "========================================"
echo ""

# Check if port is open
echo "1. Checking port 9999..."
if nc -z localhost 9999 2>/dev/null; then
    echo "   âœ“ Port 9999 is open"
else
    echo "   âŒ Port 9999 is closed"
    echo "      Run: ./openclaw-robot deploy"
    exit 1
fi

# Check what's listening
echo ""
echo "2. Checking what's listening on port 9999..."
lsof -i :9999 2>/dev/null | grep LISTEN || echo "   (lsof not available or no output)"

# Check Docker container
echo ""
echo "3. Checking Docker container..."
if docker ps | grep -q ros2-jazzy-bridge; then
    echo "   âœ“ Container is running"
    
    echo ""
    echo "4. Checking TCP server process..."
    if docker exec ros2-jazzy-bridge pgrep -f "openclaw_tcp_server" > /dev/null 2>&1; then
        echo "   âœ“ TCP server process found"
    else
        echo "   âŒ TCP server process not found"
        echo "      The server may not be running inside the container"
    fi
    
    echo ""
    echo "5. Checking TCP server logs..."
    docker exec ros2-jazzy-bridge cat /tmp/tcp_server.log 2>/dev/null | tail -20 || echo "   (no logs available)"
    
    echo ""
    echo "6. Testing with Python..."
    python3 << 'PYEOF'
import socket
import json
import time

try:
    print("   Connecting to localhost:9999...")
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(5)
    s.connect(("localhost", 9999))
    print("   âœ“ Connected")
    
    print("   Sending ping...")
    s.send(json.dumps({"action": "ping"}).encode() + b'\n')
    
    print("   Waiting for response...")
    data = s.recv(4096)
    print(f"   âœ“ Received: {data.decode()}")
    
    response = json.loads(data.decode().strip())
    print(f"   âœ“ Response status: {response.get('status')}")
    
    s.close()
    print("   âœ“ Connection closed gracefully")
    
except Exception as e:
    print(f"   âŒ Error: {e}")
PYEOF

else
    echo "   âŒ Container not running"
    echo "      Run: ./openclaw-robot deploy"
fi

echo ""
echo "========================================"
echo "Diagnostic complete"
