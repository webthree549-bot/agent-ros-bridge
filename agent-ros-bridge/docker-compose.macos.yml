# Docker Compose for macOS
# No native ROS required â€” runs entirely in Docker

version: '3.8'

services:
  bridge:
    image: ghcr.io/openclaw/agent-ros-bridge:latest
    container_name: agent-ros-bridge
    ports:
      - "8765:8765"  # WebSocket
      - "50051:50051"  # gRPC
      - "8080:8080"  # Health
      - "9090:9090"  # Metrics
    environment:
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - BRIDGE_ROS_VERSION=2
      - BRIDGE_LOG_LEVEL=INFO
      - OPENCLAW_API_KEY=${OPENCLAW_API_KEY:-}
    volumes:
      - ./config/bridge.yaml:/etc/agent-ros-bridge/bridge.yaml:ro
      - agent-ros-bridge-logs:/var/log/agent-ros-bridge
    networks:
      - ros-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: ROS2 in separate container
  # Use this for simulation or development
  ros2:
    image: ros:jazzy-ros-base
    container_name: ros2-jazzy
    command: ros2 topic list  # Keep container running
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros-network
    profiles:
      - ros  # Only start with: docker-compose --profile ros up

  # Optional: Demo dashboard
  dashboard:
    image: nginx:alpine
    container_name: agent-ros-dashboard
    ports:
      - "8773:80"
    volumes:
      - ../examples/actions/index.html:/usr/share/nginx/html/index.html:ro
    networks:
      - ros-network
    profiles:
      - demo

volumes:
  agent-ros-bridge-logs:

networks:
  ros-network:
    driver: bridge
