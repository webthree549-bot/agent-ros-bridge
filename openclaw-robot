#!/bin/bash
# openclaw-robot - PROPER ROS VERSION
# One command to deploy ROS-based robot fleet

set -euo pipefail

CMD="${1:-help}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${BLUE}[ROBOT]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
step() { echo -e "${CYAN}â–¶ $1${NC}"; }

case "$CMD" in
  deploy|start|up)
    log "ðŸš€ Deploying OpenClaw ROS Robot Fleet..."
    log ""
    
    # Step 1: Check Docker
    step "Checking Docker..."
    if ! docker info > /dev/null 2>&1; then
      error "Docker not running. Start Docker Desktop first."
      exit 1
    fi
    success "Docker is running"
    
    # Step 2: Start/Check Container
    step "Starting ROS2 Container..."
    CONTAINER_NAME="ros2-jazzy-bridge"
    
    if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
      log "Container already running"
    elif docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
      log "Starting existing container..."
      docker start "$CONTAINER_NAME"
      sleep 3
    else
      log "Creating new ROS2 container..."
      ./scripts/docker_start.sh --jazzy
      sleep 5
    fi
    success "Container ready"
    
    # Step 3: Build Project (if needed)
    step "Checking build..."
    if ! docker exec "$CONTAINER_NAME" test -d /app/install 2>/dev/null; then
      log "Building ROS2 project..."
      docker exec "$CONTAINER_NAME" bash -c "
        cd /app && 
        source /opt/ros/jazzy/setup.bash && 
        ./scripts/build.sh 2>&1 | tail -20
      " || warn "Build had warnings, continuing..."
    else
      log "Build already exists"
    fi
    success "Build ready"
    
    # Step 4: Launch ROS2 Greenhouse System â­ KEY FIX
    step "Launching ROS2 Greenhouse Nodes..."
    
    # Check if greenhouse node already running
    if docker exec "$CONTAINER_NAME" bash -c "ros2 node list 2>/dev/null | grep -q greenhouse" 2>/dev/null; then
      log "Greenhouse nodes already running"
    else
      log "Starting greenhouse launch file..."
      docker exec -d "$CONTAINER_NAME" bash -c "
        cd /app &&
        source /opt/ros/jazzy/setup.bash &&
        source install/setup.bash &&
        export MOCK_MODE=true &&
        ros2 launch demo greenhouse.launch.py > /tmp/greenhouse.log 2>&1
      "
      log "Waiting for greenhouse nodes to start..."
      sleep 5
      
      # Verify greenhouse started
      for i in {1..10}; do
        if docker exec "$CONTAINER_NAME" bash -c "ros2 node list 2>/dev/null | grep -q greenhouse" 2>/dev/null; then
          success "Greenhouse nodes active"
          break
        fi
        log "  Waiting... ($i/10)"
        sleep 2
      done
    fi
    
    # Step 5: Start TCP Server (if not running)
    step "Starting TCP Server..."
    if ! docker exec "$CONTAINER_NAME" pgrep -f "openclaw_tcp_server" > /dev/null 2>&1; then
      docker exec -d "$CONTAINER_NAME" bash -c "
        cd /app &&
        source /opt/ros/jazzy/setup.bash &&
        source install/setup.bash &&
        export MOCK_MODE=true &&
        python3 -u /app/openclaw_ros_bridge/communication/openclaw_tcp_server.py > /tmp/tcp_server.log 2>&1
      "
      sleep 2
      success "TCP server started"
    else
      log "TCP server already running"
    fi
    
    # Step 6: Verify ROS System â­ KEY VERIFICATION
    step "Verifying ROS System..."
    
    log "Active ROS nodes:"
    NODES=$(docker exec "$CONTAINER_NAME" bash -c "ros2 node list 2>/dev/null" || echo "  (none)")
    echo "$NODES" | sed 's/^/  /'
    
    log "Active ROS topics:"
    TOPICS=$(docker exec "$CONTAINER_NAME" bash -c "ros2 topic list 2>/dev/null | grep -E '(greenhouse|sensor|actuator)'" || echo "  (none)")
    if [ -n "$TOPICS" ]; then
      echo "$TOPICS" | sed 's/^/  /'
    else
      warn "No greenhouse topics found"
    fi
    
    # Step 7: Test TCP Connection
    step "Testing TCP Connection..."
    if nc -z localhost 9999 2>/dev/null; then
      success "TCP server responding on port 9999"
      
      # Test actual command
      python3 << 'PYEOF'
import socket, json, sys
try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(3)
    s.connect(("localhost", 9999))
    s.send(json.dumps({"action": "ping"}).encode() + b'\n')
    data = b''
    while b'\n' not in data:
        chunk = s.recv(4096)
        if not chunk: break
        data += chunk
    response = json.loads(data.decode().strip())
    s.close()
    if response.get("status") == "ok":
        print("  TCP command test: âœ“")
        sys.exit(0)
except Exception as e:
    print(f"  TCP command test: âœ— ({e})")
    sys.exit(1)
PYEOF
    else
      error "TCP server not responding"
    fi
    
    # Summary
    log ""
    success "âœ… ROS Robot Fleet Deployed Successfully!"
    log ""
    log "System Status:"
    log "  â€¢ Docker Container: âœ“ Running"
    log "  â€¢ ROS2 Greenhouse: âœ“ Active"
    log "  â€¢ TCP Bridge: âœ“ Connected"
    log ""
    log "Next steps:"
    log "  ./openclaw-robot status    - Check detailed status"
    log "  ./openclaw-robot-skill status  - Test robot connection"
    log "  ./openclaw-robot-skill read    - Read sensors"
    log "  ./openclaw-robot topics    - Watch ROS topics"
    log "  ./openclaw-robot cmd       - Interactive control"
    ;;
    
  status|st)
    log "Checking ROS Robot Fleet Status..."
    log ""
    
    # Container check
    if docker ps --format '{{.Names}}' | grep -q "^ros2-jazzy-bridge$"; then
      success "Container: Running"
    else
      error "Container: Not running"
      log "Run: ./openclaw-robot deploy"
      exit 1
    fi
    
    # ROS Nodes check â­ KEY
    log ""
    log "ROS2 Nodes:"
    NODES=$(docker exec ros2-jazzy-bridge bash -c "ros2 node list 2>/dev/null" || echo "  (error)")
    if [ -n "$NODES" ] && [ "$NODES" != "(error)" ]; then
      echo "$NODES" | sed 's/^/  â€¢ /'
      NODE_COUNT=$(echo "$NODES" | wc -l)
      success "Found $NODE_COUNT ROS nodes"
    else
      warn "No ROS nodes found - system may not be fully initialized"
    fi
    
    # ROS Topics check
    log ""
    log "ROS2 Topics (greenhouse):"
    TOPICS=$(docker exec ros2-jazzy-bridge bash -c "ros2 topic list 2>/dev/null | grep -E '(greenhouse|sensor|actuator)'" || echo "")
    if [ -n "$TOPICS" ]; then
      echo "$TOPICS" | sed 's/^/  â€¢ /'
    else
      warn "No greenhouse topics"
    fi
    
    # TCP check
    log ""
    if nc -z localhost 9999 2>/dev/null; then
      success "TCP Server: Listening on port 9999"
    else
      warn "TCP Server: Not responding"
    fi
    
    # Live sensor data â­ ACTUAL ROS DATA
    log ""
    log "Live Sensor Data (from ROS):"
    timeout 3 docker exec ros2-jazzy-bridge bash -c "
      source /opt/ros/jazzy/setup.bash &&
      source install/setup.bash &&
      ros2 topic echo /greenhouse/sensors --once 2>/dev/null || echo '  (no data yet)'
    " || echo "  (could not read - system starting)"
    ;;
    
  topics|watch)
    log "Watching ROS topics (Ctrl+C to stop)..."
    docker exec -it ros2-jazzy-bridge bash -c "
      source /opt/ros/jazzy/setup.bash &&
      source install/setup.bash &&
      ros2 topic echo /greenhouse/sensors
    "
    ;;
    
  nodes)
    log "Listing ROS nodes..."
    docker exec ros2-jazzy-bridge bash -c "
      source /opt/ros/jazzy/setup.bash &&
      ros2 node list
    "
    ;;
    
  cmd|chat|control)
    log "ðŸ¤– Starting interactive control..."
    log ""
    
    # Check first
    if ! docker ps --format '{{.Names}}' | grep -q "^ros2-jazzy-bridge$"; then
      error "Robot fleet not running. Deploy first:"
      error "  ./openclaw-robot deploy"
      exit 1
    fi
    
    echo "================================================"
    echo "  ðŸ¤– OpenClaw ROS Robot Control"
    echo "================================================"
    echo ""
    echo "Connected to ROS-based robot fleet"
    echo "Commands: status, read, fan on, fan off, valve open, valve close"
    echo "Or 'quit' to exit"
    echo ""
    
    while true; do
      read -p "ðŸŽ¤ You> " user_cmd
      [ -z "$user_cmd" ] && continue
      [ "$user_cmd" = "quit" ] && break
      
      # Delegate to skill
      ./openclaw-robot-skill "$user_cmd" 2>/dev/null || echo "  (command failed)"
    done
    
    echo ""
    echo "ðŸ‘‹ Control session ended"
    ;;
    
  stop|down|shutdown)
    log "Stopping ROS Robot Fleet..."
    ./scripts/docker_start.sh --stop 2>/dev/null || true
    success "Fleet stopped"
    ;;
    
  restart|reload)
    log "Restarting ROS Robot Fleet..."
    $0 stop
    sleep 2
    $0 deploy
    ;;
    
  logs)
    log "Showing TCP server logs..."
    docker exec ros2-jazzy-bridge cat /tmp/tcp_server.log 2>/dev/null | tail -30 || echo "No logs"
    ;;
    
  greenhouse-logs)
    log "Showing greenhouse logs..."
    docker exec ros2-jazzy-bridge cat /tmp/greenhouse.log 2>/dev/null | tail -30 || echo "No logs"
    ;;
    
  test|ping)
    ./openclaw-robot-test
    ;;
    
  fix)
    ./openclaw-robot-fix
    ;;
    
  help|*)
    echo "OpenClaw ROS Robot - One command for ROS-based robot control"
    echo ""
    echo "Usage: ./openclaw-robot [command]"
    echo ""
    echo "Deployment:"
    echo "  deploy, start     - Deploy ROS robot fleet"
    echo "  stop, down        - Shutdown fleet"
    echo "  restart           - Restart everything"
    echo ""
    echo "Monitoring:"
    echo "  status            - Check fleet status (with ROS nodes)"
    echo "  nodes             - List ROS nodes"
    echo "  topics            - Watch sensor topic live"
    echo "  logs              - Show TCP server logs"
    echo "  greenhouse-logs   - Show greenhouse logs"
    echo ""
    echo "Control:"
    echo "  cmd, chat         - Interactive control"
    echo "  test, ping        - Test connection"
    echo "  fix               - Fix connection issues"
    echo ""
    echo "Examples:"
    echo "  ./openclaw-robot deploy"
    echo "  ./openclaw-robot status"
    echo "  ./openclaw-robot topics"
    echo "  ./openclaw-robot-skill read"
    ;;
esac
