#!/bin/bash
# Complete test of OpenClaw Robot system

echo "üß™ Testing OpenClaw Robot Control"
echo "=================================="
echo ""

# Test 1: Container
echo "Test 1: Docker container"
if docker ps | grep -q ros2-jazzy-bridge; then
    echo "  ‚úì Container running"
else
    echo "  ‚ùå Container not running"
    echo "     Run: ./openclaw-robot deploy"
    exit 1
fi

# Test 2: TCP Server
echo ""
echo "Test 2: TCP server"
if nc -z localhost 9999 2>/dev/null; then
    echo "  ‚úì Port 9999 open"
else
    echo "  ‚ùå Port 9999 closed"
    exit 1
fi

# Test 3: Direct Python test
echo ""
echo "Test 3: Direct connection"
python3 << 'PYEOF'
import socket
import json
import sys

try:
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(5)
    s.connect(("localhost", 9999))
    
    # Send ping
    s.send(json.dumps({"action": "ping"}).encode() + b'\n')
    
    # Receive
    data = b''
    while b'\n' not in data:
        chunk = s.recv(4096)
        if not chunk:
            break
        data += chunk
    
    response = json.loads(data.decode().strip())
    
    if response.get("status") == "ok":
        print("  ‚úì Ping successful")
        sys.exit(0)
    else:
        print(f"  ‚ö†Ô∏è  Unexpected response: {response}")
        sys.exit(1)
        
except Exception as e:
    print(f"  ‚ùå Failed: {e}")
    sys.exit(1)
PYEOF

if [ $? -ne 0 ]; then
    echo ""
    echo "Direct connection failed. Trying to fix..."
    echo "Run: ./openclaw-robot-fix"
    exit 1
fi

# Test 4: Skill command
echo ""
echo "Test 4: Skill command"
./openclaw-robot-skill ping > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "  ‚úì Skill command works"
else
    echo "  ‚ö†Ô∏è  Skill command had issues (direct connection works though)"
fi

# Test 5: Full status
echo ""
echo "Test 5: Full status query"
./openclaw-robot-skill status

echo ""
echo "=================================="
echo "‚úÖ All tests passed!"
echo ""
echo "Next: Try controlling the robot"
echo "  ./openclaw-robot-skill read"
echo "  ./openclaw-robot-skill 'fan on'"
