#!/usr/bin/env python3
"""
OpenClaw Robot Skill - Robust robot control from OpenClaw
Handles connection issues gracefully
"""
import socket
import json
import sys
import time

def send_command(cmd_dict, host="localhost", port=9999, timeout=5):
    """Send command to robot fleet with retry logic"""
    max_retries = 3
    
    for attempt in range(max_retries):
        try:
            s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            s.settimeout(timeout)
            s.connect((host, port))
            
            # Send command
            cmd_json = json.dumps(cmd_dict) + '\n'
            s.sendall(cmd_json.encode('utf-8'))
            
            # Receive response
            response_data = b''
            while b'\n' not in response_data:
                chunk = s.recv(4096)
                if not chunk:
                    break
                response_data += chunk
            
            s.close()
            
            # Parse response
            if response_data:
                response = json.loads(response_data.decode('utf-8').strip())
                return response
            else:
                return {"status": "error", "message": "Empty response"}
                
        except socket.timeout:
            if attempt < max_retries - 1:
                time.sleep(0.5)
                continue
            return {"status": "error", "message": "Connection timeout"}
        except ConnectionResetError:
            if attempt < max_retries - 1:
                time.sleep(0.5)
                continue
            return {"status": "error", "message": "Connection reset by peer - server may be initializing"}
        except Exception as e:
            return {"status": "error", "message": str(e)}
    
    return {"status": "error", "message": "Max retries exceeded"}

def main():
    # Parse command from arguments or stdin
    if len(sys.argv) > 1:
        user_cmd = " ".join(sys.argv[1:])
    else:
        user_cmd = sys.stdin.read().strip()
    
    if not user_cmd:
        print("ðŸ¤– OpenClaw Robot Skill")
        print("")
        print("Usage: openclaw-robot-skill <command>")
        print("  or: echo 'command' | openclaw-robot-skill")
        print("")
        print("Commands: status, read, ping, fan on, fan off, valve open, valve close, help")
        sys.exit(1)
    
    cmd_lower = user_cmd.lower()
    
    # Quick connection test for status command
    if cmd_lower in ["status", "check status", "robot status"]:
        print("ðŸ¤– Checking robot fleet status...")
        
        # Try ping first
        r = send_command({"action": "ping"}, timeout=3)
        if r.get('status') != 'ok':
            print(f"âŒ Cannot connect to robot fleet")
            print(f"   Error: {r.get('message', 'Unknown error')}")
            print("")
            print("   To fix:")
            print("   1. Deploy the fleet: ./openclaw-robot deploy")
            print("   2. Wait 10 seconds for initialization")
            print("   3. Try again: ./openclaw-robot-skill status")
            sys.exit(1)
        
        # Get full status
        r = send_command({"action": "get_status"})
        if r.get('status') == 'ok':
            print(f"âœ“ Robot Fleet Connected")
            print(f"")
            print(f"   ROS Version: {r.get('ros', 'unknown')}")
            print(f"   Mode: {'Simulation' if r.get('mock') else 'Hardware'}")
            print(f"   OpenClaw Protocol: {r.get('openclaw_version', 'unknown')}")
            print(f"")
            print(f"   Try: ./openclaw-robot-skill read")
        else:
            print(f"âš ï¸  Connected but status query failed: {r.get('message')}")
    
    elif cmd_lower in ["read", "temp", "temperature", "check temperature", "sensors"]:
        print("ðŸŒ¡ï¸  Reading sensors...")
        r = send_command({"action": "read_sensor", "sensor": "env"})
        if r.get('status') == 'ok':
            d = r.get('data', {})
            temp = d.get('temperature', 'N/A')
            humidity = d.get('humidity', 'N/A')
            mock = d.get('mock_mode', False)
            
            print(f"")
            print(f"   Temperature: {temp}Â°C")
            print(f"   Humidity: {humidity}%")
            if mock:
                print(f"   Mode: Simulation (MOCK_MODE=true)")
            
            # AI suggestion
            if isinstance(temp, (int, float)):
                if temp > 28:
                    print(f"")
                    print(f"   ðŸ’¡ Suggestion: Temperature is high. Consider:")
                    print(f"      ./openclaw-robot-skill 'fan on'")
                elif temp < 18:
                    print(f"")
                    print(f"   ðŸ’¡ Suggestion: Temperature is low.")
                else:
                    print(f"")
                    print(f"   âœ“ Temperature is comfortable")
        else:
            print(f"âŒ Error reading sensors: {r.get('message')}")
    
    elif cmd_lower in ["fan on", "turn on fan", "start fan"]:
        print("ðŸŒ€ Turning fan ON...")
        r = send_command({"action": "write_actuator", "actuator": "fan", "value": True})
        if r.get('status') == 'ok':
            print(f"âœ“ {r.get('message', 'Fan turned ON')}")
        else:
            print(f"âŒ Error: {r.get('message')}")
    
    elif cmd_lower in ["fan off", "turn off fan", "stop fan"]:
        print("ðŸŒ€ Turning fan OFF...")
        r = send_command({"action": "write_actuator", "actuator": "fan", "value": False})
        if r.get('status') == 'ok':
            print(f"âœ“ {r.get('message', 'Fan turned OFF')}")
        else:
            print(f"âŒ Error: {r.get('message')}")
    
    elif cmd_lower in ["valve open", "open valve", "water on", "start water"]:
        print("ðŸ’¦ Opening valve...")
        r = send_command({"action": "write_actuator", "actuator": "valve", "value": True})
        if r.get('status') == 'ok':
            print(f"âœ“ Valve OPENED - Watering plants")
        else:
            print(f"âŒ Error: {r.get('message')}")
    
    elif cmd_lower in ["valve close", "close valve", "water off", "stop water"]:
        print("ðŸ’¦ Closing valve...")
        r = send_command({"action": "write_actuator", "actuator": "valve", "value": False})
        if r.get('status') == 'ok':
            print(f"âœ“ Valve CLOSED")
        else:
            print(f"âŒ Error: {r.get('message')}")
    
    elif cmd_lower in ["ping", "test", "hello", "check"]:
        print("ðŸ” Testing connection...")
        r = send_command({"action": "ping"})
        if r.get('status') == 'ok':
            print(f"âœ“ Robot fleet is responding")
            print(f"   Pong: {r.get('pong', True)}")
        else:
            print(f"âŒ No response from robots")
            print(f"   Error: {r.get('message')}")
            print("")
            print("   To start the fleet:")
            print("   ./openclaw-robot deploy")
    
    elif cmd_lower in ["help", "?", "commands", "h"]:
        print("ðŸ¤– OpenClaw Robot Commands:")
        print("")
        print("Status & Monitoring:")
        print("  status          - Check robot fleet status")
        print("  read            - Read temperature and humidity")
        print("  ping            - Test connection")
        print("")
        print("Environment Control:")
        print("  fan on          - Turn on ventilation fan")
        print("  fan off         - Turn off ventilation fan")
        print("  valve open      - Open water valve")
        print("  valve close     - Close water valve")
        print("")
        print("Examples:")
        print("  ./openclaw-robot-skill status")
        print("  ./openclaw-robot-skill read")
        print("  ./openclaw-robot-skill 'fan on'")
        print("")
        print("Fleet Management:")
        print("  ./openclaw-robot deploy   - Start robot fleet")
        print("  ./openclaw-robot stop     - Stop robot fleet")
        print("  ./openclaw-robot status   - Check fleet health")
    
    else:
        print(f"â“ Unknown command: '{user_cmd}'")
        print("   Type 'help' for available commands")
        sys.exit(1)

if __name__ == "__main__":
    main()
