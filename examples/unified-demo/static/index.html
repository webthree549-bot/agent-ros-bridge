<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent ROS Bridge - Unified Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 40px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .back-btn {
            display: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .back-btn:hover { background: rgba(255,255,255,0.2); }
        
        /* Selector View */
        .selector-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .example-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .example-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            border-color: rgba(0,212,255,0.3);
        }
        
        .example-icon { font-size: 3em; margin-bottom: 12px; }
        .example-title { font-size: 1.3em; font-weight: 600; margin-bottom: 8px; }
        .example-desc { color: #888; font-size: 0.9em; margin-bottom: 16px; }
        
        /* Detail View */
        .detail-view {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .detail-header {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .detail-header h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .detail-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
        }
        
        .control-panel h3 {
            color: #00d4ff;
            margin-bottom: 16px;
        }
        
        .main-panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            min-height: 500px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn:hover { opacity: 0.9; }
        .btn.secondary { background: rgba(255,255,255,0.1); }
        .btn.success { background: linear-gradient(90deg, #2ecc71, #27ae60); }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .status-badge.running {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .status-badge.stopped {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
        }
        
        .placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #888;
            font-size: 1.2em;
            flex-direction: column;
        }
        
        #iframe-container {
            position: relative;
            height: 600px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        #iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: rgba(0,0,0,0.2);
        }
        
        #iframe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26,26,46,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10;
        }
        
        #iframe-overlay.visible {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Agent ROS Bridge</h1>
        <p>Unified Demo Environment</p>
    </div>
    
    <button class="back-btn" onclick="showSelector()">‚Üê Back to Examples</button>
    
    <!-- Selector Grid -->
    <div class="selector-view" id="selector">
        <div class="example-card" onclick="showExample('talking-garden')">
            <div class="example-icon">üå±</div>
            <div class="example-title">Talking Garden</div>
            <div class="example-desc">AI monitors and converses with 6 IoT-enabled plants</div>
        </div>
        
        <div class="example-card" onclick="showExample('mars-colony')">
            <div class="example-icon">üöÄ</div>
            <div class="example-title">Mars Colony</div>
            <div class="example-desc">Multi-robot Mars mission with 4 robot types</div>
        </div>
        
        <div class="example-card" onclick="showExample('theater-bots')">
            <div class="example-icon">üé≠</div>
            <div class="example-title">Theater Bots</div>
            <div class="example-desc">AI director controls robot actors on stage</div>
        </div>
        
        <div class="example-card" onclick="showExample('art-studio')">
            <div class="example-icon">üé®</div>
            <div class="example-title">Art Studio</div>
            <div class="example-desc">Human and robot collaborative painting</div>
        </div>
        
        <div class="example-card" onclick="showExample('actions')">
            <div class="example-icon">‚ö°</div>
            <div class="example-title">Actions Demo</div>
            <div class="example-desc">ROS Actions for navigation and manipulation</div>
        </div>
        
        <div class="example-card" onclick="showExample('auth')">
            <div class="example-icon">üîê</div>
            <div class="example-title">Auth Demo</div>
            <div class="example-desc">JWT authentication demonstration</div>
        </div>
        
        <div class="example-card" onclick="showExample('fleet')">
            <div class="example-icon">üöÅ</div>
            <div class="example-title">Fleet Demo</div>
            <div class="example-desc">Multi-robot fleet coordination</div>
        </div>
        
        <div class="example-card" onclick="showExample('quickstart')">
            <div class="example-icon">üöÄ</div>
            <div class="example-title">Quickstart</div>
            <div class="example-desc">Basic bridge usage tutorial</div>
        </div>
    </div>
    
    <!-- Detail View -->
    <div class="detail-view" id="detail">
        <div class="detail-header">
            <h2>
                <span id="detail-icon">üå±</span>
                <span id="detail-title">Example Name</span>
                <span class="status-badge stopped" id="detail-status">‚óè Stopped</span>
            </h2>
            <p id="detail-desc" style="color: #888;">Description goes here</p>
        </div>
        
        <div class="detail-layout">
            <div class="control-panel">
                <h3>Controls</h3>
                <button class="btn success" id="start-btn" onclick="startCurrent()">‚ñ∂ Start Example</button>
                <button class="btn" id="stop-btn" onclick="stopCurrent()" style="display: none;">‚èπ Stop</button>
                <button class="btn secondary" onclick="showLogs()">üìã Show Logs</button>
                <div id="logs-panel" style="margin-top: 20px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-family: monospace; font-size: 0.8em; display: none; max-height: 200px; overflow-y: auto;">
                    Logs will appear here...
                </div>
            </div>
            
            <div class="main-panel">
                <div id="example-content">
                    <div class="placeholder">
                        Click "Start Example" to launch the demo
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentExample = null;
        let examplePort = null;
        
        const EXAMPLES = {
            'talking-garden': { icon: 'üå±', title: 'Talking Garden', desc: 'AI monitors and converses with 6 IoT-enabled plants', port: 8081 },
            'mars-colony': { icon: 'üöÄ', title: 'Mars Colony', desc: 'Multi-robot Mars mission with 4 robot types', port: 8082 },
            'theater-bots': { icon: 'üé≠', title: 'Theater Bots', desc: 'AI director controls robot actors on stage', port: 8083 },
            'art-studio': { icon: 'üé®', title: 'Art Studio', desc: 'Human and robot collaborative painting', port: 8084 },
            'actions': { icon: '‚ö°', title: 'Actions Demo', desc: 'ROS Actions for navigation and manipulation', port: 8085 },
            'auth': { icon: 'üîê', title: 'Auth Demo', desc: 'JWT authentication demonstration', port: 8086 },
            'fleet': { icon: 'üöÅ', title: 'Fleet Demo', desc: 'Multi-robot fleet coordination', port: 8087 },
            'quickstart': { icon: 'üöÄ', title: 'Quickstart', desc: 'Basic bridge usage tutorial', port: 8090 }
        };
        
        function showSelector() {
            document.getElementById('selector').style.display = 'grid';
            document.getElementById('detail').style.display = 'none';
            document.querySelector('.back-btn').style.display = 'none';
            currentExample = null;
        }
        
        function showExample(id) {
            currentExample = id;
            const ex = EXAMPLES[id];
            
            document.getElementById('detail-icon').textContent = ex.icon;
            document.getElementById('detail-title').textContent = ex.title;
            document.getElementById('detail-desc').textContent = ex.desc;
            examplePort = ex.port;
            
            document.getElementById('selector').style.display = 'none';
            document.getElementById('detail').style.display = 'block';
            document.querySelector('.back-btn').style.display = 'block';
            
            // Reset content
            document.getElementById('example-content').innerHTML = `
                <div class="placeholder">
                    Click "Start Example" to launch ${ex.title}
                </div>
            `;
            updateStatus('stopped');
        }
        
        function updateStatus(status) {
            const badge = document.getElementById('detail-status');
            if (status === 'running') {
                badge.textContent = '‚óè Running';
                badge.className = 'status-badge running';
                document.getElementById('start-btn').style.display = 'none';
                document.getElementById('stop-btn').style.display = 'block';
            } else {
                badge.textContent = '‚óè Stopped';
                badge.className = 'status-badge stopped';
                document.getElementById('start-btn').style.display = 'block';
                document.getElementById('stop-btn').style.display = 'none';
            }
        }
        
        async function startCurrent() {
            if (!currentExample) return;
            
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Starting...';
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`/api/start/${currentExample}`, { 
                    method: 'POST',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('running');
                    const ex = EXAMPLES[currentExample];
                    loadExampleFrame(ex.port);
                    log('Example started successfully');
                } else {
                    log('Failed to start: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    log('Error: Request timed out. Server may be busy.', 'error');
                } else {
                    log('Error: ' + err.message, 'error');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ñ∂ Start Example';
            }
        }
        
        function loadExampleFrame(port) {
            // Create iframe with loading indicator
            document.getElementById('example-content').innerHTML = `
                <div id="iframe-container" style="position: relative; height: 100%;">
                    <iframe id="demo-iframe" src="http://localhost:${port}/" 
                        style="width: 100%; height: 100%; border: none;"
                        onload="onIframeLoad()"
                        onerror="onIframeError()">
                    </iframe>
                    <div id="iframe-overlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26,26,46,0.95); display: flex; align-items: center; justify-content: center; flex-direction: column;">
                        <h3 style="color: #e74c3c; margin-bottom: 10px;">‚èπ Demo Stopped</h3>
                        <p style="color: #888;">The demo is no longer running</p>
                        <button class="btn" onclick="startCurrent()" style="margin-top: 20px;">‚ñ∂ Restart Demo</button>
                    </div>
                </div>
            `;
            
            // Try to ping the server to confirm it's ready
            setTimeout(() => checkFrameHealth(port), 2000);
        }
        
        async function checkFrameHealth(port) {
            try {
                const response = await fetch(`http://localhost:${port}/`, { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                // If we get here, server is responding
                document.getElementById('iframe-overlay').style.display = 'none';
            } catch (e) {
                // Server not ready yet, retry
                setTimeout(() => checkFrameHealth(port), 1000);
            }
        }
        
        function showStoppedOverlay() {
            const overlay = document.getElementById('iframe-overlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }
        
        async function stopCurrent() {
            if (!currentExample) return;
            
            try {
                const response = await fetch(`/api/stop/${currentExample}`, { method: 'POST' });
                updateStatus('stopped');
                
                // Show stopped overlay on iframe
                showStoppedOverlay();
                
                log('Example stopped');
            } catch (err) {
                log('Error stopping: ' + err.message, 'error');
            }
        }
        
        function showLogs() {
            const panel = document.getElementById('logs-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function log(msg, type = 'info') {
            const panel = document.getElementById('logs-panel');
            const line = document.createElement('div');
            line.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#2ecc71' : '#fff';
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            panel.appendChild(line);
            panel.scrollTop = panel.scrollHeight;
        }
    </script>
</body>
</html>
