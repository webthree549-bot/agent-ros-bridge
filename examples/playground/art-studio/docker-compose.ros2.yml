version: '3.8'

# ROS2 Art Studio - Real ROS2 Nodes + HTTP Server
# Run with: docker-compose -f docker-compose.ros2.yml up --build
# Access: http://localhost:8080 (Visual interface)
#         ws://localhost:8765 (WebSocket)

services:
  # Art Studio: Bridge + HTTP Server + ROS2 Nodes
  art-studio:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: art-studio-full
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - ROS_DOMAIN_ID=0
    ports:
      - "8765:8765"   # Agent ROS Bridge WebSocket
      - "8080:8080"   # HTTP Server (canvas.html)
    networks:
      - ros2-network
    # Uses CMD from Dockerfile

  # Painter Robot 1
  painter-1:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: painter-1-ros2
    environment:
      - ROBOT_ID=painter_1
      - ROBOT_STYLE=abstract
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run art_studio painter_node
      "

  # Painter Robot 2
  painter-2:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: painter-2-ros2
    environment:
      - ROBOT_ID=painter_2
      - ROBOT_STYLE=impressionist
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run art_studio painter_node
      "

  # Canvas Aggregator
  canvas:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: canvas-ros2
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run art_studio canvas_node
      "

  # ROS2 Topic Monitor (for debugging)
  ros2-monitor:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: ros2-monitor
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        echo '=== ROS2 Topics ===' &&
        ros2 topic list &&
        echo '=== Monitoring /art/strokes ===' &&
        ros2 topic echo /art/strokes
      "

networks:
  ros2-network:
    driver: bridge