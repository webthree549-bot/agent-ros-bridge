version: '3.8'

# ROS2 Talking Garden - Real ROS2 Nodes + HTTP Server
# Run with: docker-compose -f docker-compose.ros2.yml up --build
# Access: http://localhost:8080 (Garden interface)
#         ws://localhost:8765 (WebSocket)

services:
  # Garden: Bridge + HTTP Server + Oracle
  garden-main:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: garden-main
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - ROS_DOMAIN_ID=0
    ports:
      - "8765:8765"   # Agent ROS Bridge WebSocket
      - "8080:8080"   # HTTP Server (garden.html)
    networks:
      - ros2-network
    # Uses CMD from Dockerfile

  # Plant 1: Fernando the Fern
  plant-fernando:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: plant-fernando
    environment:
      - PLANT_ID=fernando
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden plant_node
      "

  # Plant 2: Cactilda the Cactus
  plant-cactilda:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: plant-cactilda
    environment:
      - PLANT_ID=cactilda
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden plant_node
      "

  # Plant 3: Rosalind the Rose
  plant-rosalind:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: plant-rosalind
    environment:
      - PLANT_ID=rosalind
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden plant_node
      "

  # Plant 4: Basilion the Basil
  plant-basilion:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: plant-basilion
    environment:
      - PLANT_ID=basilion
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden plant_node
      "

  # Plant 5: Orchidelle the Orchid
  plant-orchidelle:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: plant-orchidelle
    environment:
      - PLANT_ID=orchidelle
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden plant_node
      "

  # Plant 6: Sunflower Sam
  plant-sunflower:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: plant-sunflower
    environment:
      - PLANT_ID=sunflower_sam
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden plant_node
      "

  # Gardener bot
  gardener:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: gardener-1
    environment:
      - GARDENER_NAME=1
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden gardener_node
      "

  # Oracle node (poetry generator)
  oracle:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: garden-oracle
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run garden oracle_node
      "

  # ROS2 Topic Monitor (for debugging)
  ros2-monitor:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: garden-ros2-monitor
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        sleep 5 &&
        echo '=== ROS2 Topics ===' &&
        ros2 topic list &&
        echo '=== Monitoring /garden/sensors ===' &&
        ros2 topic echo /garden/sensors
      "

networks:
  ros2-network:
    driver: bridge
