version: '3.8'

# ROS2 Mars Colony - Real ROS2 Nodes + HTTP Server
# Run with: docker-compose -f docker-compose.ros2.yml up --build
# Access: http://localhost:8080 (Dashboard)
#         localhost:50051 (gRPC Bridge)

services:
  # Mars: Bridge + HTTP Server
  mars-bridge:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: mars-bridge
    environment:
      - ROS_DOMAIN_ID=0
    ports:
      - "50051:50051"  # Agent ROS Bridge gRPC
      - "8080:8080"    # HTTP Server (dashboard.html)
    networks:
      - ros2-network
    # Uses CMD from Dockerfile

  # Command Center: Mission control and coordination
  mars-command:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: mars-command
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run mars_colony command_node
      "

  # Excavator: Mining operations
  mars-excavator:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: mars-excavator
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run mars_colony excavator_node
      "

  # Solar Drone: Power generation and aerial survey
  mars-solar-drone:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: mars-solar-drone
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run mars_colony solar_drone_node
      "

  # Builder: Construction and habitat building
  mars-builder:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: mars-builder
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run mars_colony builder_node
      "

  # Scout: Exploration and mapping
  mars-scout:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: mars-scout
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        ros2 run mars_colony scout_node
      "

  # ROS2 Topic Monitor (for debugging)
  ros2-monitor:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    container_name: mars-ros2-monitor
    environment:
      - ROS_DOMAIN_ID=0
    networks:
      - ros2-network
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        source /ros2_ws/install/setup.bash &&
        sleep 5 &&
        echo '=== Mars Colony ROS2 Topics ===' &&
        ros2 topic list &&
        echo '=== Monitoring /mars/sensors ===' &&
        ros2 topic echo /mars/sensors
      "

networks:
  ros2-network:
    driver: bridge
