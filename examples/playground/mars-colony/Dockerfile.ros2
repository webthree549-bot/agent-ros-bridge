# ROS2 Mars - Bridge + HTTP Combined (Fixed)
FROM ros:humble-ros-base

RUN apt-get update && apt-get install -y python3-pip && rm -rf /var/lib/apt/lists/*
RUN pip3 install websockets==11.0.3 aiohttp>=3.8 numpy

# Copy agent_ros_bridge directly to site-packages
COPY agent_ros_bridge/ /usr/local/lib/python3.10/dist-packages/agent_ros_bridge/

# Type hints fixed in source (using string annotations)

WORKDIR /ros2_ws
COPY ros2/mars_colony/ src/mars_colony/
COPY mars_bridge_http.py ./
COPY dashboard.html ./
RUN /bin/bash -c "source /opt/ros/humble/setup.bash && colcon build"

ENV ROS_DOMAIN_ID=0
EXPOSE 50051 8080

CMD ["/bin/bash", "-c", "source /opt/ros/humble/setup.bash && source install/setup.bash && python3 mars_bridge_http.py"]