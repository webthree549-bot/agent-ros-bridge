version: '3.8'

services:
  # ROS1 bridge (Noetic)
  ros1-bridge:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros1
    image: agent-ros-bridge:ros1
    container_name: agent-ros-bridge-ros1
    profiles: ["ros1"]
    ports:
      - "8765:8765"    # WebSocket
      - "50051:50051"  # gRPC
    environment:
      - ROS_MASTER_URI=http://ros-master:11311
      - ROS_HOSTNAME=ros1-bridge
    networks:
      - ros-network

  # ROS2 bridge (Jazzy)
  ros2-bridge:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros2
    image: agent-ros-bridge:ros2
    container_name: agent-ros-bridge-ros2
    profiles: ["ros2"]
    ports:
      - "8767:8765"    # WebSocket (host:container)
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_LOCALHOST_ONLY=0
    networks:
      - ros-network

  # ROS1 Master (required for ROS1)
  ros-master:
    image: ros:noetic-ros-core
    container_name: ros-master
    profiles: ["ros1"]
    command: roscore
    networks:
      - ros-network

  # Optional: TurtleBot4 simulator (ROS2)
  turtlebot4-sim:
    image: ros:jazzy-desktop
    container_name: turtlebot4-sim
    profiles: ["sim"]
    environment:
      - ROS_DOMAIN_ID=0
      - DISPLAY=${DISPLAY:-:0}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
    command: >
      bash -c "
        source /opt/ros/jazzy/setup.bash &&
        ros2 launch turtlebot4_gz_bringup turtlebot4_gz.launch.py
      "
    networks:
      - ros-network

networks:
  ros-network:
    driver: bridge
